#! /usr/bin/env node

const request = require('request')
const fs = require('fs')

const parser = require('../lib/parser')
const formatter = require('../lib/formatter')
const filepath = require('../lib/filepath')

let [, , username, dest] = process.argv

if (!username) throw new Error('Missing username argument')
if (!dest) dest = '.'

const url = `http://${username}.deviantart.com/journal/`
const headers = {
  // DeviantArt requires a user agent, or times the request out
  'User-Agent': 'node-js-request'
}

request({ url, headers }, function (error, response, body) {
  if (error || response.statusCode !== 200) {
    console.log(`Error fetching ${url}, error: ${error}`)
  }

  parser(body).map(journal => {
    fs.writeFileSync(filepath(dest, journal), formatter(journal))
  })
})
